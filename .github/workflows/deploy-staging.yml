name: Deploy to Staging

on:
  pull_request:
    branches: [develop]

jobs:
  build-and-test:
    name: "Build and Test"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: TypeScript compilation check
        run: npx tsc --noEmit

      - name: Build project
        run: npm run build

      - name: Create deployment package
        run: |
          mkdir -p deploy-package-staging
          cp -r dist/* deploy-package-staging/
          cp package.json package-lock.json ecosystem.config.json deploy-package-staging/
          echo "# Environment variables will be created during deployment" > deploy-package-staging/.env.example

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: staging-deploy-package
          path: deploy-package-staging/
          retention-days: 7

  deploy-staging:
    name: "Deploy to Staging"
    needs: build-and-test
    runs-on: ubuntu-latest
    environment: staging

    # ĞšĞ»ÑÑ‡ĞµĞ²Ğ¾Ğµ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğµ: Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ¿Ñ€Ğ¸ Ğ¼ĞµÑ€Ğ¶Ğµ PR Ğ² develop
    if: github.event.pull_request.merged == true

    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: staging-deploy-package

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Prepare deployment
        env:
          BOT_NAME: "fate-bot-staging"
        run: |
          echo "ğŸš€ Starting STAGING deployment"
          echo "ğŸ” PR #${{ github.event.pull_request.number }}"
          echo "ğŸ” Merge status: ${{ github.event.pull_request.merged }}"

          if [ "${{ github.event.pull_request.merged }}" != "true" ]; then
            echo "â„¹ï¸ PR not merged, skipping deployment"
            exit 0
          fi

          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          SERVER_USER="${{ secrets.SERVER_USER }}"
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

          INIT_CMD='export NVM_DIR="/home/devops/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" && nvm use 24.13.0'

          ssh_with_nvm() {
            local cmd="$1"
            ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "$INIT_CMD && $cmd"
          }

          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ backup
          echo "ğŸ’¾ Creating backup..."
          ssh_with_nvm "
            if [ -d '$DEPLOY_PATH' ]; then
              BACKUP_DIR='/tmp/fate-bot-staging-backup-\$(date +%Y%m%d-%H%M%S)'
              mkdir -p \$BACKUP_DIR
              cp -r $DEPLOY_PATH/* \$BACKUP_DIR/ 2>/dev/null || true
              echo 'Staging backup created at: '\$BACKUP_DIR
            fi
          "

      - name: Deploy to staging server
        env:
          BOT_NAME: "fate-bot-staging"
          ENVIRONMENT: "staging"
        run: |
          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          SERVER_USER="${{ secrets.SERVER_USER }}"
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

          INIT_CMD='export NVM_DIR="/home/devops/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" && nvm use 24.13.0'

          ssh_with_nvm() {
            local cmd="$1"
            ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "$INIT_CMD && $cmd"
          }

          # 1. ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ staging Ğ±Ğ¾Ñ‚Ğ°
          echo "â¸ï¸ Stopping $BOT_NAME..."
          ssh_with_nvm "pm2 stop $BOT_NAME 2>/dev/null || true"
          sleep 3

          # 2. ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ
          echo "ğŸ§¹ Cleaning deployment directory..."
          ssh_with_nvm "
            mkdir -p $DEPLOY_PATH $DEPLOY_PATH/logs
            if [ -d '$DEPLOY_PATH/logs' ]; then
              mv $DEPLOY_PATH/logs $DEPLOY_PATH/logs.backup
            fi
            find $DEPLOY_PATH -maxdepth 1 ! -name '.env.*' ! -name '.env' ! -name 'logs.backup' -type f -delete 2>/dev/null || true
            rm -rf $DEPLOY_PATH/dist 2>/dev/null || true
            if [ -d '$DEPLOY_PATH/logs.backup' ]; then
              mv $DEPLOY_PATH/logs.backup $DEPLOY_PATH/logs
            fi
          "

          # 3. ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          echo "ğŸ“¤ Copying files..."
          scp -o ConnectTimeout=10 -o StrictHostKeyChecking=no -r ./dist "$SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/"
          scp -o ConnectTimeout=10 -o StrictHostKeyChecking=no package.json package-lock.json ecosystem.config.json \
            "$SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/"

          # 4. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ .env.staging Ñ„Ğ°Ğ¹Ğ» (Ğ‘Ğ•Ğ— Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿Ğ¾Ğ²!)
          echo "âš™ï¸ Creating .env.staging file..."
          ssh_with_nvm "
            cd $DEPLOY_PATH
            cat > .env.staging << 'EOF'
          BOT_TOKEN=${{ secrets.STAGING_BOT_TOKEN }}
          ADMIN_ID=${{ secrets.ADMIN_ID }}
          NODE_ENV=staging
          DEPLOYED_AT=\$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          GIT_COMMIT=${{ github.event.pull_request.merge_commit_sha }}
          GIT_BRANCH=develop
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_AUTHOR=${{ github.event.pull_request.user.login }}
          EOF
          "

          # 5. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
          echo "ğŸ“¦ Installing dependencies..."
          ssh_with_nvm "cd $DEPLOY_PATH && npm ci --omit=dev"

          # 6. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ staging Ğ±Ğ¾Ñ‚Ğ°
          echo "ğŸš€ Starting $BOT_NAME..."
          ssh_with_nvm "cd $DEPLOY_PATH && pm2 start ecosystem.config.json --env $ENVIRONMENT --only $BOT_NAME"

          # 7. ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ¿ÑƒÑĞº PM2
          echo "âš™ï¸ Configuring PM2 startup..."
          ssh_with_nvm "pm2 save"

      - name: Verify staging deployment
        run: |
          echo "ğŸ” Verifying staging deployment..."

          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          SERVER_USER="${{ secrets.SERVER_USER }}"

          INIT_CMD='export NVM_DIR="/home/devops/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" && nvm use 24.13.0'

          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "$INIT_CMD && \
            echo '=== Staging Bot ===' && \
            pm2 status | grep -A2 'fate-bot-staging' || echo 'Bot status not available'"

      - name: Notify success
        if: success()
        run: |
          echo "âœ… Staging deployment completed!"
          echo "ğŸ“Š PR #${{ github.event.pull_request.number }} merged into develop"

      - name: Rollback on failure
        if: failure()
        env:
          BOT_NAME: "fate-bot-staging"
        run: |
          echo "âŒ Staging deployment failed"
          echo "âš ï¸ Check logs for details"
