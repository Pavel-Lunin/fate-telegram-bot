name: Deploy to Production

on:
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    name: "Build and Test"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: TypeScript compilation check
        run: npx tsc --noEmit

      - name: Build project
        run: npm run build

      - name: Additional production tests
        run: |
          echo "Running production-specific checks..."
          echo "âœ“ Build size check"
          du -sh dist/
          echo "âœ“ File count"
          find dist/ -type f | wc -l

      - name: Create deployment package
        run: |
          mkdir -p deploy-package-prod
          cp -r dist/* deploy-package-prod/
          cp package.json package-lock.json ecosystem.config.json deploy-package-prod/
          echo "# Environment variables will be created during deployment" > deploy-package-prod/.env.example

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: production-deploy-package
          path: deploy-package-prod/
          retention-days: 7

  deploy-production:
    name: "Deploy to Production"
    needs: build-and-test
    runs-on: ubuntu-latest
    environment: production

    # ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ Ğ’ĞĞ–ĞĞ: Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ¿Ñ€Ğ¸ Ğ¼ĞµÑ€Ğ¶Ğµ PR Ğ² main
    if: github.event.pull_request.merged == true

    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: production-deploy-package

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Production deployment approval check
        run: |
          echo "ğŸš¨ PRODUCTION DEPLOYMENT ğŸš¨"
          echo "âš ï¸  This will deploy to PRODUCTION environment"
          echo "ğŸ“Š PR #${{ github.event.pull_request.number }}"
          echo "ğŸ“ Title: ${{ github.event.pull_request.title }}"
          echo "ğŸ§‘â€ğŸ’» Author: ${{ github.event.pull_request.user.login }}"
          echo "ğŸ”— PR URL: ${{ github.event.pull_request.html_url }}"
          echo "ğŸ” Environment: ${{ github.event.repository.name }}/production"
          echo "ğŸ” Merge status: ${{ github.event.pull_request.merged }}"
          echo "ğŸ” Merge commit: ${{ github.event.pull_request.merge_commit_sha }}"

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¼ĞµÑ€Ğ¶
          if [ "${{ github.event.pull_request.merged }}" != "true" ]; then
            echo "âŒ ERROR: PR was closed without merging. Aborting production deployment."
            exit 1
          fi

          if [ -z "${{ github.event.pull_request.merge_commit_sha }}" ]; then
            echo "âš ï¸ WARNING: Merge commit SHA is empty"
          fi

      - name: Prepare production deployment
        env:
          BOT_NAME: "fate-bot-production"
        run: |
          echo "ğŸ›¡ï¸ Preparing PRODUCTION deployment..."

          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          SERVER_USER="${{ secrets.SERVER_USER }}"
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

          INIT_CMD='export NVM_DIR="/home/devops/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" && nvm use 24.13.0'

          ssh_with_nvm() {
            local cmd="$1"
            ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "$INIT_CMD && $cmd"
          }

          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ backup Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ production Ğ²ĞµÑ€ÑĞ¸Ğ¸ (Ğ’ĞĞ–ĞĞ!)
          echo "ğŸ’¾ Creating production backup..."
          ssh_with_nvm "
            if [ -d '$DEPLOY_PATH' ]; then
              BACKUP_DIR='/tmp/fate-bot-production-backup-\$(date +%Y%m%d-%H%M%S)'
              mkdir -p \$BACKUP_DIR
              cp -r $DEPLOY_PATH/* \$BACKUP_DIR/ 2>/dev/null || true
              echo 'PRODUCTION backup created at: '\$BACKUP_DIR
              echo 'âš ï¸ SAVE THIS PATH FOR ROLLBACK: '\$BACKUP_DIR
            else
              echo 'âš ï¸ No existing production deployment found'
            fi
          "

      - name: Deploy to production server
        env:
          BOT_NAME: "fate-bot-production"
          ENVIRONMENT: "production"
        run: |
          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          SERVER_USER="${{ secrets.SERVER_USER }}"
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

          INIT_CMD='export NVM_DIR="/home/devops/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" && nvm use 24.13.0'

          ssh_with_nvm() {
            local cmd="$1"
            ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "$INIT_CMD && $cmd"
          }

          # 1. ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ production Ğ±Ğ¾Ñ‚Ğ°
          echo "â¸ï¸ Stopping PRODUCTION bot ($BOT_NAME)..."
          ssh_with_nvm "pm2 stop $BOT_NAME 2>/dev/null || true"
          sleep 5

          # 2. ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ
          echo "ğŸ§¹ Cleaning production directory..."
          ssh_with_nvm "
            mkdir -p $DEPLOY_PATH $DEPLOY_PATH/logs
            if [ -d '$DEPLOY_PATH/logs' ]; then
              cp -r $DEPLOY_PATH/logs $DEPLOY_PATH/logs.backup.production
            fi
            find $DEPLOY_PATH -maxdepth 1 ! -name '.env.*' ! -name '.env' ! -name 'logs.backup.*' -type f -delete 2>/dev/null || true
            rm -rf $DEPLOY_PATH/dist 2>/dev/null || true
          "

          # 3. ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğ° production ÑĞµÑ€Ğ²ĞµÑ€
          echo "ğŸ“¤ Copying files to PRODUCTION..."
          scp -o ConnectTimeout=10 -o StrictHostKeyChecking=no -r ./dist "$SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/"
          scp -o ConnectTimeout=10 -o StrictHostKeyChecking=no package.json package-lock.json ecosystem.config.json \
            "$SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/"

          # 4. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ .env.production Ñ„Ğ°Ğ¹Ğ» (Ğ‘Ğ•Ğ— Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿Ğ¾Ğ² Ğ¿ĞµÑ€ĞµĞ´ ÑÑ‚Ñ€Ğ¾ĞºĞ°Ğ¼Ğ¸!)
          echo "âš™ï¸ Creating .env.production file..."
          ssh_with_nvm "
            cd $DEPLOY_PATH
            cat > .env.production << 'EOF'
          BOT_TOKEN=${{ secrets.PRODUCTION_BOT_TOKEN }}
          ADMIN_ID=${{ secrets.ADMIN_ID }}
          NODE_ENV=production
          DEPLOYED_AT=\$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          GIT_COMMIT=${{ github.event.pull_request.merge_commit_sha }}
          GIT_BRANCH=main
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_AUTHOR=${{ github.event.pull_request.user.login }}
          DEPLOY_MODE=ci_cd
          EOF
          "

          # 5. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ production
          echo "ğŸ“¦ Installing PRODUCTION dependencies..."
          ssh_with_nvm "cd $DEPLOY_PATH && npm ci --omit=dev --audit=false"

          # 6. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ production Ğ±Ğ¾Ñ‚Ğ°
          echo "ğŸš€ Starting PRODUCTION bot..."
          ssh_with_nvm "cd $DEPLOY_PATH && pm2 start ecosystem.config.json --env $ENVIRONMENT --only $BOT_NAME"

          # 7. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ PM2 ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
          echo "ğŸ’¾ Saving PM2 production config..."
          ssh_with_nvm "pm2 save"

      - name: Verify production deployment
        run: |
          echo "ğŸ” Verifying PRODUCTION deployment..."

          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          SERVER_USER="${{ secrets.SERVER_USER }}"

          INIT_CMD='export NVM_DIR="/home/devops/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" && nvm use 24.13.0'

          echo "=== Production Bot Status ==="
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "$INIT_CMD && \
            pm2 show fate-bot-production --silent 2>/dev/null || echo 'Production bot not found'"

          echo ""
          echo "=== Health Check ==="
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "$INIT_CMD && \
            pm2 jlist 2>/dev/null | grep -A5 'fate-bot-production' || echo 'Status check failed'"

      - name: Production health check
        if: success()
        run: |
          echo "ğŸ¥ Production health check passed!"
          echo "ğŸ“Š Deployment Summary:"
          echo "  âœ… PR: #${{ github.event.pull_request.number }}"
          echo "  âœ… Bot: fate-bot-production"
          echo "  âœ… Deployed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

      - name: Emergency rollback procedure
        if: failure()
        env:
          BOT_NAME: "fate-bot-production"
        run: |
          echo "ğŸš¨ EMERGENCY: Production deployment failed!"
          echo "âš ï¸  Check logs above for details"
          echo ""
          echo "Manual rollback steps if needed:"
          echo "1. SSH: ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
          echo "2. Find backup: ls -la /tmp/fate-bot-production-backup-*"
          echo "3. Restore if needed"

      - name: Notify production deployment
        if: success()
        run: |
          echo "ğŸ‰ PRODUCTION DEPLOYMENT SUCCESSFUL!"
          echo "ğŸ“‹ PR #${{ github.event.pull_request.number }} deployed by ${{ github.event.pull_request.user.login }}"
