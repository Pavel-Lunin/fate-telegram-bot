name: Deploy to Production

on:
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    name: "Build and Test"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: TypeScript compilation check
        run: npx tsc --noEmit

      - name: Build project
        run: npm run build

      - name: Additional production tests
        run: |
          # ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ»Ñ production
          echo "Running production-specific checks..."
          echo "âœ“ Build size check"
          du -sh dist/
          echo "âœ“ File count"
          find dist/ -type f | wc -l

      - name: Create deployment package
        run: |
          mkdir -p deploy-package
          cp -r dist/* deploy-package/
          cp package.json package-lock.json ecosystem.config.json deploy-package/
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ .env Ñ„Ğ°Ğ¹Ğ»-ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½
          echo "# Environment variables will be created during deployment" > deploy-package/.env.example

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: production-deploy-package
          path: deploy-package/
          retention-days: 7

  deploy-production:
    name: "Deploy to Production"
    needs: build-and-test
    runs-on: ubuntu-latest
    environment: production

    # ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ Ğ’ĞĞ–ĞĞ: Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ¿Ñ€Ğ¸ Ğ¼ĞµÑ€Ğ¶Ğµ PR Ğ² main
    if: github.event.pull_request.merged == true

    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: production-deploy-package

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Production deployment approval check
        run: |
          echo "ğŸš¨ PRODUCTION DEPLOYMENT ğŸš¨"
          echo "âš ï¸  This will deploy to PRODUCTION environment"
          echo "ğŸ“Š PR #${{ github.event.pull_request.number }} merged into main"
          echo "ğŸ“ Title: ${{ github.event.pull_request.title }}"
          echo "ğŸ§‘â€ğŸ’» Author: ${{ github.event.pull_request.user.login }}"
          echo "ğŸ”— PR URL: ${{ github.event.pull_request.html_url }}"
          echo "ğŸ” Environment: ${{ github.event.repository.name }}/production"

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¼ĞµÑ€Ğ¶ (Ğ° Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ)
          if [ "${{ github.event.pull_request.merged }}" != "true" ]; then
            echo "âŒ ERROR: PR was closed without merging. Aborting production deployment."
            exit 1
          fi

      - name: Prepare production deployment
        env:
          BOT_NAME: "fate-bot-production"
        run: |
          echo "ğŸ›¡ï¸ Preparing PRODUCTION deployment..."

          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          SERVER_USER="${{ secrets.SERVER_USER }}"
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

          INIT_CMD='export NVM_DIR="/home/devops/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" && nvm use 24.13.0'

          ssh_with_nvm() {
            local cmd="$1"
            ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "$INIT_CMD && $cmd"
          }

          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ backup Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ production Ğ²ĞµÑ€ÑĞ¸Ğ¸ (Ğ’ĞĞ–ĞĞ!)
          echo "ğŸ’¾ Creating production backup..."
          ssh_with_nvm "
            if [ -d '$DEPLOY_PATH' ]; then
              BACKUP_DIR='/tmp/fate-bot-production-backup-$(date +%Y%m%d-%H%M%S)'
              mkdir -p \$BACKUP_DIR
              cp -r $DEPLOY_PATH/* \$BACKUP_DIR/ 2>/dev/null || true
              echo 'PRODUCTION backup created at: '\$BACKUP_DIR
              echo 'âš ï¸ SAVE THIS PATH FOR ROLLBACK: '\$BACKUP_DIR
            else
              echo 'âš ï¸ No existing production deployment found'
            fi
          "

      - name: Deploy to production server
        env:
          BOT_NAME: "fate-bot-production"
          ENVIRONMENT: "production"
        run: |
          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          SERVER_USER="${{ secrets.SERVER_USER }}"
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

          INIT_CMD='export NVM_DIR="/home/devops/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" && nvm use 24.13.0'

          ssh_with_nvm() {
            local cmd="$1"
            ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "$INIT_CMD && $cmd"
          }

          # 1. ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ production Ğ±Ğ¾Ñ‚Ğ°
          echo "â¸ï¸ Stopping PRODUCTION bot ($BOT_NAME)..."
          ssh_with_nvm "pm2 stop $BOT_NAME 2>/dev/null || true"
          sleep 5  # Ğ”Ğ°ĞµĞ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ´Ğ»Ñ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğ°

          # 2. ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ (Ğ±Ğ¾Ğ»ĞµĞµ Ğ¾ÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğ°)
          echo "ğŸ§¹ Cleaning production directory..."
          ssh_with_nvm "
            mkdir -p $DEPLOY_PATH $DEPLOY_PATH/logs
            # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ»Ğ¾Ğ³Ğ¸
            if [ -d '$DEPLOY_PATH/logs' ]; then
              cp -r $DEPLOY_PATH/logs $DEPLOY_PATH/logs.backup.production
            fi
            # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²ÑÑ‘ ĞºÑ€Ğ¾Ğ¼Ğµ .env Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ¸ backup Ğ»Ğ¾Ğ³Ğ¾Ğ²
            find $DEPLOY_PATH -maxdepth 1 ! -name '.env.*' ! -name '.env' ! -name 'logs.backup.*' -type f -delete 2>/dev/null || true
            rm -rf $DEPLOY_PATH/dist 2>/dev/null || true
          "

          # 3. ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğ° production ÑĞµÑ€Ğ²ĞµÑ€
          echo "ğŸ“¤ Copying files to PRODUCTION..."
          scp -o ConnectTimeout=10 -o StrictHostKeyChecking=no -r ./dist "$SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/"
          scp -o ConnectTimeout=10 -o StrictHostKeyChecking=no package.json package-lock.json ecosystem.config.json \
            "$SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/"

          # 4. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ .env.production Ñ„Ğ°Ğ¹Ğ» Ğ¸Ğ· GitHub Secrets
          echo "âš™ï¸ Creating .env.production file..."
          ssh_with_nvm "
            cd $DEPLOY_PATH
            cat > .env.production << 'EOF'
            BOT_TOKEN=${{ secrets.PRODUCTION_BOT_TOKEN }}
            ADMIN_ID=${{ secrets.ADMIN_ID }}
            NODE_ENV=production
            DEPLOYED_AT=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            GIT_COMMIT=${{ github.event.pull_request.merge_commit_sha }}
            GIT_BRANCH=main
            PR_NUMBER=${{ github.event.pull_request.number }}
            PR_AUTHOR=${{ github.event.pull_request.user.login }}
            DEPLOY_MODE=ci_cd
            EOF
          "

          # 5. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ production
          echo "ğŸ“¦ Installing PRODUCTION dependencies..."
          ssh_with_nvm "cd $DEPLOY_PATH && npm ci --omit=dev --audit=false"

          # 6. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ production Ğ±Ğ¾Ñ‚Ğ°
          echo "ğŸš€ Starting PRODUCTION bot..."
          ssh_with_nvm "cd $DEPLOY_PATH && pm2 start ecosystem.config.json --env $ENVIRONMENT --only $BOT_NAME"

          # 7. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ PM2 ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
          echo "ğŸ’¾ Saving PM2 production config..."
          ssh_with_nvm "pm2 save"

      - name: Verify production deployment
        run: |
          echo "ğŸ” Verifying PRODUCTION deployment..."

          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          SERVER_USER="${{ secrets.SERVER_USER }}"

          INIT_CMD='export NVM_DIR="/home/devops/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" && nvm use 24.13.0'

          echo "=== Production Bot Status ==="
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "$INIT_CMD && \
            pm2 show fate-bot-production --silent || echo 'Production bot not found'"

          echo ""
          echo "=== Health Check ==="
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "$INIT_CMD && \
            echo 'Uptime:' && \
            pm2 jlist | jq -r '.[] | select(.name==\"fate-bot-production\") | .pm2_env.status' 2>/dev/null || echo 'Status check failed'"

          echo ""
          echo "=== Recent Production Logs (last 3 lines) ==="
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "$INIT_CMD && \
            timeout 3 pm2 logs fate-bot-production --lines 3 --nostream 2>/dev/null || echo 'Log check timeout'"

      - name: Production health check
        run: |
          echo "ğŸ¥ Performing production health check..."
          echo "âœ… Production deployment appears successful"
          echo "ğŸ“Š Deployment Summary:"
          echo "  - PR: #${{ github.event.pull_request.number }}"
          echo "  - Commit: ${{ github.event.pull_request.merge_commit_sha | slice: 0, 8 }}"
          echo "  - Deployed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "  - Environment: production"

      - name: Emergency rollback procedure
        if: failure()
        env:
          BOT_NAME: "fate-bot-production"
        run: |
          echo "ğŸš¨ EMERGENCY: Production deployment failed!"
          echo "âš ï¸  Attempting emergency rollback..."
          echo ""
          echo "Manual rollback steps:"
          echo "1. SSH to production server: ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
          echo "2. Navigate to backup: cd /tmp/fate-bot-production-backup-*"
          echo "3. Restore: cp -r * ${{ secrets.DEPLOY_PATH }}/"
          echo "4. Restart: pm2 restart fate-bot-production"
          echo ""
          echo "Automated rollback attempt:"

          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          SERVER_USER="${{ secrets.SERVER_USER }}"
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

          INIT_CMD='export NVM_DIR="/home/devops/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" && nvm use 24.13.0'

          # ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "$INIT_CMD && \
            echo 'Attempting to restart previous version...' && \
            pm2 restart $BOT_NAME 2>/dev/null || \
            echo 'âŒ Automatic rollback failed. Manual intervention required!'"

          echo "ğŸ”´ PRODUCTION DEPLOYMENT FAILED - NEEDS IMMEDIATE ATTENTION"

      - name: Notify production deployment
        if: success()
        run: |
          echo "ğŸ‰ PRODUCTION DEPLOYMENT SUCCESSFUL!"
          echo "ğŸ“‹ Summary:"
          echo "  âœ… PR #${{ github.event.pull_request.number }} deployed to production"
          echo "  âœ… Bot: fate-bot-production"
          echo "  âœ… Commit: ${{ github.event.pull_request.merge_commit_sha }}"
          echo "  âœ… Deployed by: ${{ github.event.pull_request.user.login }}"
          echo "  âœ… Time: $(date)"
