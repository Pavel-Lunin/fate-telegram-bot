# ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ workflow (Ð±ÑƒÐ´ÐµÑ‚ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°Ñ‚ÑŒÑÑ Ð² Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐµ GitHub)
name: Deploy Telegram Bot

# ÐšÐ¾Ð³Ð´Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ workflow:
# 1. ÐŸÑ€Ð¸ push Ð² Ð²ÐµÑ‚ÐºÐ¸ main Ð¸Ð»Ð¸ develop
# 2. ÐŸÑ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ pull request Ð² ÑÑ‚Ð¸ Ð²ÐµÑ‚ÐºÐ¸
on:
  push:
    branches:
      - main # ÐŸÑ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½ Ð²ÐµÑ‚ÐºÐ°
      - develop # Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°
  pull_request:
    branches:
      - main
      - develop

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð´Ð»Ñ Ð²ÑÐµÑ… ÑˆÐ°Ð³Ð¾Ð²
defaults:
  run:
    # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ bash ÐºÐ°Ðº Ð¾Ð±Ð¾Ð»Ð¾Ñ‡ÐºÑƒ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
    shell: bash
    # Ð’ÑÐµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑ‚ÑŒÑÑ Ð¸Ð· ÐºÐ¾Ñ€Ð½Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
    working-directory: ./

# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ, Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð²Ð¾ Ð²ÑÐµÑ… job
env:
  # Ð’ÐµÑ€ÑÐ¸Ñ Node.js - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ LTS Ð²ÐµÑ€ÑÐ¸ÑŽ 20.x
  NODE_VERSION: "20"
  # ÐŸÐ°Ð¿ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸
  DIST_FOLDER: "dist"

# Job 1: Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð°
jobs:
  build:
    # ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ job Ð² Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐµ
    name: "Build and Test"

    # Ð“Ð´Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ job
    # ubuntu-latest Ð²ÑÐµÐ³Ð´Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑŽÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Ubuntu
    # ÐÐµ Ð½ÑƒÐ¶Ð½Ð¾ Ð¼ÐµÐ½ÑÑ‚ÑŒ Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð°
    runs-on: ubuntu-latest

    # Ð¨Ð°Ð³Ð¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽÑ‚ÑÑ Ð¿Ð¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾
    steps:
      # Ð¨Ð°Ð³ 1: ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð° Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      - name: Checkout repository
        # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¹ action Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÐºÐ¾Ð´Ð°
        uses: actions/checkout@v4
        with:
          # ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð² Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð°, ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ð¼ Ð²Ñ€ÐµÐ¼Ñ
          fetch-depth: 0

      # Ð¨Ð°Ð³ 2: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Node.js Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ env.NODE_VERSION
          node-version: ${{ env.NODE_VERSION }}
          # ÐšÑÑˆÐ¸Ñ€ÑƒÐµÐ¼ node_modules Ð´Ð»Ñ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð²
          cache: "npm"

      # Ð¨Ð°Ð³ 3: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      - name: Install dependencies
        # npm ci Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ package-lock.json Ð´Ð»Ñ Ñ‚Ð¾Ñ‡Ð½Ð¾Ð³Ð¾ Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÐ´ÐµÐ½Ð¸Ñ
        run: npm ci

      # Ð¨Ð°Ð³ 4: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° TypeScript ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ð¸
      - name: TypeScript compilation check
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ TypeScript ÐºÐ¾Ð´ ÐºÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð±ÐµÐ· Ð¾ÑˆÐ¸Ð±Ð¾Ðº
        run: npx tsc --noEmit

      # Ð¨Ð°Ð³ 5: Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
      - name: Build project
        # ÐšÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÐ¼ TypeScript Ð² JavaScript
        run: npm run build

      # Ð¨Ð°Ð³ 6: Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          # Ð§Ñ‚Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼:
          path: |
            dist/           # Ð¡Ð¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ JavaScript ÐºÐ¾Ð´
            package.json    # ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
            package-lock.json # Ð’ÐµÑ€ÑÐ¸Ð¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
            ecosystem.config.json # ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ PM2
          # Ð¥Ñ€Ð°Ð½Ð¸Ð¼ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ 7 Ð´Ð½ÐµÐ¹
          retention-days: 7

  # Job 2: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
  deploy:
    # ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ job
    name: "Deploy to Server"

    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ ÑÐ±Ð¾Ñ€ÐºÐ¸
    needs: build

    # Ð“Ð´Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ
    runs-on: ubuntu-latest

    # Ð£ÑÐ»Ð¾Ð²Ð¸Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°:
    # 1. Ð”Ð»Ñ develop - Ð²ÑÐµÐ³Ð´Ð° Ð¿Ñ€Ð¸ push (Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹)
    # 2. Ð”Ð»Ñ main - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ push (Ð½Ðµ Ð¿Ñ€Ð¸ pull_request)
    if: |
      (github.ref == 'refs/heads/develop' && github.event_name == 'push') ||
      (github.ref == 'refs/heads/main' && github.event_name == 'push')

    # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ (staging/production)
    environment:
      # Ð•ÑÐ»Ð¸ Ð²ÐµÑ‚ÐºÐ° develop - staging, ÐµÑÐ»Ð¸ main - production
      name: ${{ github.ref == 'refs/heads/develop' && 'staging' || 'production' }}

    steps:
      # Ð¨Ð°Ð³ 1: Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· job build
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output

      # Ð¨Ð°Ð³ 2: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSH Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ
      - name: Setup SSH
        # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ action Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ SSH ÐºÐ»ÑŽÑ‡Ð°Ð¼Ð¸
        uses: webfactory/ssh-agent@v0.9.0
        with:
          # Ð‘ÐµÑ€ÐµÐ¼ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ SSH ÐºÐ»ÑŽÑ‡ Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² GitHub
          ssh-private-key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}

      # Ð¨Ð°Ð³ 3: Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÐµÑ€Ð²ÐµÑ€ Ð² known_hosts
      - name: Add server to known hosts
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ .ssh ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
          mkdir -p ~/.ssh
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ»ÑŽÑ‡ ÑÐµÑ€Ð²ÐµÑ€Ð° Ð² known_hosts Ð´Ð»Ñ Ð¸Ð·Ð±ÐµÐ¶Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # Ð¨Ð°Ð³ 4: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
      - name: Deploy to server
        run: |
          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
          if [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            ENVIRONMENT="staging"
            BOT_TOKEN="${{ secrets.STAGING_BOT_TOKEN }}"
          else
            ENVIRONMENT="production"
            BOT_TOKEN="${{ secrets.PRODUCTION_BOT_TOKEN }}"
          fi

          echo "ðŸš€ Starting deployment to $ENVIRONMENT"
          echo "ðŸ“¦ Branch: ${{ github.ref_name }}"
          echo "ðŸ”‘ Commit: ${{ github.sha }}"

          # ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±ÑÑ‚Ð²Ð°
          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          SERVER_USER="${{ secrets.SERVER_USER }}"
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

          # 1. ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð±Ð¾Ñ‚ (ÐµÑÐ»Ð¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½)
          echo "â¸ï¸ Stopping bot..."
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST \
            "cd $DEPLOY_PATH && pm2 stop fate-bot 2>/dev/null || true"

          # 2. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸
          echo "ðŸ’¾ Creating backup..."
          BACKUP_TIME=$(date +%Y%m%d_%H%M%S)
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST \
            "cd $DEPLOY_PATH && \
             [ -d dist ] && cp -r dist dist_backup_$BACKUP_TIME || true"

          # 3. ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
          echo "ðŸ“¤ Copying files to server..."

          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ dist Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST \
            "mkdir -p $DEPLOY_PATH/dist"

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          scp -o StrictHostKeyChecking=no -r ./dist/* \
            $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/dist/

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          scp -o StrictHostKeyChecking=no package.json package-lock.json ecosystem.config.json \
            $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/

          # 4. ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ñ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð¼ Ð±Ð¾Ñ‚Ð°
          echo "âš™ï¸ Updating .env file..."
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST \
            "cd $DEPLOY_PATH && \
             if [ -f .env ]; then \
               sed -i 's/TELEGRAM_BOT_TOKEN=.*/TELEGRAM_BOT_TOKEN=$BOT_TOKEN/' .env; \
             else \
               echo 'TELEGRAM_BOT_TOKEN=$BOT_TOKEN' > .env; \
             fi"

          # 5. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
          echo "ðŸ“¦ Installing dependencies..."
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST \
            "cd $DEPLOY_PATH && npm ci --only=production"

          # 6. Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
          echo "ðŸš€ Starting bot..."
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST \
            "cd $DEPLOY_PATH && pm2 start ecosystem.config.json --env $ENVIRONMENT"

          # 7. Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ PM2 Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°
          echo "ðŸ’¾ Saving PM2 configuration..."
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST \
            "cd $DEPLOY_PATH && pm2 save"

          echo "âœ… Deployment completed!"

      # Ð¨Ð°Ð³ 5: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´ÐµÐ¿Ð»Ð¾Ñ
      - name: Verify deployment
        run: |
          echo "ðŸ” Verifying deployment..."

          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          SERVER_USER="${{ secrets.SERVER_USER }}"
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ PM2
          echo "ðŸ“Š PM2 Status:"
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST \
            "pm2 status fate-bot"

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸ (Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 3 ÑÑ‚Ñ€Ð¾ÐºÐ¸)
          echo "ðŸ“‹ Recent logs:"
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST \
            "tail -3 $DEPLOY_PATH/logs/combined.log 2>/dev/null || echo 'No logs yet'"
